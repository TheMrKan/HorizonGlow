<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/styles/style.css">
    <script type="text/javascript" src="/static/js/jquery-3.7.1.min.js"></script>
    <title>Horizon Glow: Login</title>
</head>
<body>
<iframe src="/static/blank.html" id="loginTarget" name="loginTarget" style="display:none">
</iframe>
<section class="section container">
    <p class="title is-3 has-text-centered">HORIZON GLOW</p>
    <div class="columns is-centered">
        <div class="column is-4">
            <div class="box">
                <p class="subtitle is-4 has-text-weight-semibold has-text-centered">Welcome back</p>

                <form id="login-form" method="post" action="/api/return/200/" target="loginTarget">
                    <div class="field" id="username-field">
                        <label class="label">Username</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" name="username" placeholder="Username" autocomplete="username">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <div class="field" id="password-field">
                        <label class="label">Password</label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input" type="password" name="password" placeholder="Enter your password" autocomplete="current-password">
                            <span class="icon is-small is-left">
                                <i class="fas fa-key"></i>
                            </span>
                            <span class="icon is-small is-right">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>
                </form>

                <form id="secretPhrase-form" method="post" action="/api/return/200/" target="loginTarget" class="mt-3">
                    <div class="field" id="secretPhrase-field">
                        <label class="label">
                            Secret phrase
                            <span class="is-size-7 has-text-weight-light">(One word, case insensetive)</span>
                        </label>
                        <div class="control has-icons-left">
                            <input class="input" type="password" name="secretPhrase" placeholder="Secret">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user-secret"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                </form>

                <p class="has-text-danger has-text-centered" id="error"></p>
                <button class="button mt-5 is-outlined is-medium is-fullwidth is-primary" form="login-form" id="submit-button" type="submit">Login</button>

                <div class="mt-3 has-text-centered">
                    <span class="is-size-6">Don't have an account? <a href="/auth/signup">Sign up</a></span>
                </div>
            </div>
        </div>
    </div>
</section>

<script type="text/javascript">
    $(document).ready(function() {
        $("#login-form").submit(submit);

        setError();
        setFieldError($("#password-field"));
    });

    function setError(text=null) {
        const elem = $("#error");
        elem.toggle(text !== "" && text !== null);
        elem.text(text)
    }

    function setFieldError(field, text=null) {
        const active = text !== "" && text !== null;
        field.find("input").toggleClass("is-danger", active);
        field.find(".is-right").toggle(active);
        field.find(".help").text(text);
    }

    function submit(e) {
        const username = $("#username-field .input").val();
        const password = $("#password-field .input").val().trim();
        const secretPhrase = $("#secretPhrase-field .input").val().trim();

        setFieldError($("#username-field"));
        setFieldError($("#password-field"));
        setFieldError($("#secretPhrase-field"));
        setError();

        if (username === null || username.trim() === "") {
            setFieldError($("#username-field"), "Username is required");
            return;
        }

        if (password === null || password.trim() === "") {
            setFieldError($("#password-field"), "Password is required");
            return;
        }

        if (secretPhrase === null || secretPhrase.trim() === "") {
            setFieldError($("#secretPhrase-field"), "Secret phrase is required");
            return;
        }

        const request = {
            username: username,
            password: password,
            secretPhrase: secretPhrase
        }

        $("#submit-button").addClass("is-loading");

        $.post({
            data: request,
            url: "/api/auth/login/",
            dataType: "json",
            success: function(data) {
                window.location.href = "/";
            },
            error: function(jqXHR, textStatus, errorThrown) {
                if (jqXHR.status == 401) {
                    setError("Incorrect username, password or secret phrase");
                }
                else if (jqXHR.status == 400) {
                    try {
                        let errors = JSON.parse(jqXHR.responseText);
                        if ("detail" in errors) {
                            setError(errors["detail"])
                            return;
                        }
                        if ("username" in errors) {
                            setFieldError($("#username-field"), errors["username"]);
                        }
                        if ("password" in errors) {
                            setFieldError($("#password1-field"), errors["password"]);
                        }
                        if ("secretPhrase" in errors) {
                            setFieldError($("#secretPhrase-field"), errors["secretPhrase"]);
                        }
                    }
                    catch (e) {
                        console.error("Failed to parse JSON error: " + e);
                        console.error("Response: " + jqXHR.responseText);
                        setError("An internal error occured during the request. Please, try again.")
                    }
                }
                else {
                    console.error("Response: " + jqXHR.responseText);
                    setError("An internal error occured during the request. Please, try again.")
                }
            },
            complete: function(jqXHR, textStatus) {
                $("#submit-button").removeClass("is-loading");
            }
        })
    }
</script>
</body>
</html>