<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/styles/style.css">
    <script type="text/javascript" src="/static/js/jquery-3.7.1.min.js"></script>
    <title>Horizon Glow: Sign up</title>
</head>
<body>
<iframe src="/static/blank.html" id="signupTarget" name="signupTarget" style="display:none">
</iframe>
<section class="section container">
    <p class="title is-3 has-text-centered">HORIZON GLOW</p>
    <div class="columns is-centered">
        <div class="column is-4">
            <div class="box">
                <p class="subtitle is-4 has-text-weight-semibold has-text-centered">Create new account</p>

                <form id="signup-form" method="post" action="/api/return/200/" target="signupTarget">
                    <div class="field" id="username-field">
                        <label class="label">Username</label>
                        <div class="control has-icons-left">
                            <input class="input" type="text" name="username" placeholder="Username" autocomplete="username">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <div class="field" id="password1-field">
                        <label class="label">Password</label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input" type="password" name="password1" placeholder="Enter your password" autocomplete="new-password">
                            <span class="icon is-small is-left">
                                <i class="fas fa-key"></i>
                            </span>
                            <span class="icon is-small is-right">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <div class="field" id="password2-field">
                        <label class="label">Password confirmation</label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input" type="password" name="password2" placeholder="Re-enter your password" autocomplete="new-password">
                            <span class="icon is-small is-left">
                                <i class="fas fa-key"></i>
                            </span>
                            <span class="icon is-small is-right">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <div class="field" id="secretPhrase-field">
                        <label class="label">
                            Secret phrase
                            <span class="is-size-7 has-text-weight-light">(One word, case insensetive)</span>
                        </label>
                        <div class="control has-icons-left">
                            <input class="input" type="password" placeholder="Secret">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user-secret"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <p class="has-text-danger has-text-centered" id="error"></p>

                    <button class="button mt-5 is-outlined is-medium is-fullwidth is-primary" id="submit-button" type="submit">Get Started</button>
                </form>

                <div class="mt-3 has-text-centered">
                    <span class="is-size-6">Already have an account? <a href="/auth/login">Sign in</a></span>
                </div>
            </div>
        </div>
    </div>
</section>

<script type="text/javascript">
    $(document).ready(function() {
        $("#submit-button").click(submit);

        setPasswordsDontMatch(false);
        setError();
    });

    function setError(text=null) {
        const elem = $("#error");
        elem.toggle(text !== "" && text !== null);
        elem.text(text)
    }

    function setFieldError(field, text=null) {
        const active = text !== "" && text !== null;
        field.find("input").toggleClass("is-danger", active);
        field.find(".is-right").toggle(active);
        field.find(".help").text(text);
    }

    function setPasswordsDontMatch(active) {
        const text = active ? "Passwords don't match" : "";
        setFieldError($("#password1-field"), text);
        setFieldError($("#password2-field"), text);
    }

    function submit() {
        const username = $("#username-field .input").val();
        const password1 = $("#password1-field .input").val().trim();
        const password2 = $("#password2-field .input").val().trim();
        const secretPhrase = $("#secretPhrase-field .input").val().trim();

        setFieldError($("#username-field"));
        setPasswordsDontMatch(false);
        setFieldError($("#secretPhrase-field"));
        setError();

        if (username === null || username.trim() === "") {
            setFieldError($("#username-field"), "Username is required");
            return;
        }

        if (password1 === null || password1.trim() === "") {
            setFieldError($("#password1-field"), "Password is required");
            return;
        }

        if (password1 !== password2) {
            setPasswordsDontMatch(true);
            return;
        }

        if (secretPhrase === null || secretPhrase.trim() === "") {
            setFieldError($("#secretPhrase-field"), "Secret phrase is required");
            return;
        }

        const request = {
            username: username,
            password: password1,
            secretPhrase: secretPhrase
        }

        $("#submit-button").addClass("is-loading");

        $.post({
            data: request,
            url: "/api/auth/register/",
            dataType: "json",
            success: function(data) {
                window.location.href = "/";
            },
            error: function(jqXHR, textStatus, errorThrown) {
                if (jqXHR.status != 400) {
                    console.error("Response: " + jqXHR.responseText);
                    setError("An internal error occured during the request. Please, try again.");
                    return;
                }

                try {
                    let errors = JSON.parse(jqXHR.responseText);
                    if ("username" in errors) {
                        setFieldError($("#username-field"), errors["username"]);
                    }
                    if ("password" in errors) {
                        setFieldError($("#password1-field"), errors["password"]);
                    }
                    if ("secretPhrase" in errors) {
                        setFieldError($("#secretPhrase-field"), errors["secretPhrase"]);
                    }
                }
                catch (e) {
                    console.error("Failed to parse JSON error: " + e);
                    console.error("Response: " + jqXHR.responseText);
                    setError("An internal error occured during the request. Please, try again.")
                }
            },
            complete: function(jqXHR, textStatus) {
                $("#submit-button").removeClass("is-loading");
            }
        })
    }
</script>
</body>
</html>