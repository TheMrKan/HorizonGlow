<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/styles/style.css">
    <script type="text/javascript" src="/static/js/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="/static/js/app.js"></script>
    <script type="text/javascript" src="/static/js/header.js"></script>
    <title>Miami Cash: Home</title>
</head>
<body>
    <script>
        const MIN_PRODUCTS_COUNT = 20;
        const LOAD_PRODUCTS_COUNT = 10;
        let categories = new Map();
        let loading = [];
        let loadedProducts = 0;
        let categoriesSelector = null;
        let currentFilter = 0;
        let toTopButton = null;

        $(document).ready(function() {
            toTopButton = $(".scroll-to-top-button").first();

            loadProfile();
            loadCategories();
            loadArticle();

            categoriesSelector = $("#categoriesSelect");
            categoriesSelector.on("change", function () {
                filterCategories(this.value);
            });
        });

        window.onscroll = function() {onScroll()};

        function onScroll() {
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                toTopButton.css("display", "");
              } else {
                toTopButton.css("display", "none");
              }
        }

        function scrollToTop() {
            toTopButton.trigger("mouseleave");

            window.scrollTo({top: 0, behavior: 'smooth'});

            toTopButton.trigger("mouseenter");
        }

        function loadCategories() {
            $.get({
                url: "/api/categories/",
                dataType: "json",
                success: function(data) {
                    categoriesSelector.children().remove("[value!=0]");

                    let index = 0;
                    let hasNotLoaded = false;
                    for (let categ of data) {
                        categories.set(categ.id, categ);
                        categ["isLoaded"] = false;
                        categ["index"] = index++;
                        categoriesSelector.append($("<option>", {
                            value: categ.id,
                            text: categ.name,
                        }));

                        if (categ["productsCount"] > 0) {
                            if (loadedProducts < MIN_PRODUCTS_COUNT) {
                                loadedProducts += categ["productsCount"];
                                loadCategory(categ.id, categ.name, categ["descriptionUrl"], true);
                            }
                            else {
                                let el = loadCategory(categ.id, categ.name, categ["descriptionUrl"], false);
                                hasNotLoaded = true;
                            }
                        }
                    }
                    categoriesSelector.removeClass("is-skeleton");
                    if (!hasNotLoaded) {
                        $("#loadMoreButton").hide();
                    }

                    if (loadedProducts === 0) {
                        $("#noProducts").show();
                        $("#categoriesBag").hide();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    tryHandleAuthError(jqXHR);

                    showError(jqXHR);
                }
            });
        }

        function loadCategory(id, name, descriptionUrl, loadProducts) {
            const element = getOrCreateCategoryElement(id);    // должно создаваться синхронно, чтобы сохранялся порядок

            if (descriptionUrl !== "" && descriptionUrl !== null) {
                element.find("button").first().show().click(() => window.open(descriptionUrl, '_blank').focus());
            }
            if (!loadProducts) return element;

            loading.push(id);
            element.show();
            categories.get(id)["isLoaded"] = true;
            $.get({
                url: `/api/products/?category=${id}`,
                dataType: "json",
                success: function(data) {

                    const categNameElement = element.find(".is-size-5");
                    categNameElement.removeClass("is-skeleton");
                    categNameElement.addClass("has-text-weight-bold is-size-5 has-text-primary");
                    categNameElement.text(name);

                    for (let product of data) {
                        addProduct(id, product);
                    }

                    if (loading.length <= 1) {
                        $("#categoryTemplate").hide();
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    tryHandleAuthError(jqXHR);

                    showError(jqXHR);
                },
                complete: function() {
                    loading.splice(loading.indexOf(id));
                }
            });

            return element;
        }

        function loadAdditionalCategories() {
            if (loading.length > 0 || loadedProducts === 0) return;

            const initialProducts = loadedProducts;
            for (let [id, category] of categories) {
                if (category["productsCount"] === 0) {
                    continue;
                }

                if (category["isLoaded"]) {
                    let el = $(`#category-${id}`);
                    if (el.length !== 0) {
                        if (el.first().css("display") === "none") {
                            el.show();
                        }
                        continue;
                    }
                }

                loadedProducts += category["productsCount"];
                loadCategory(category["id"], category["name"], null, true);

                if (loadedProducts - initialProducts >= LOAD_PRODUCTS_COUNT) {
                    break;
                }
            }

            if (Array.from(categories.values()).every((c) => (c["isLoaded"] && $(`#category-${c['id']}`).first().css("display") !== "none") || c["productsCount"] === 0)) {
                $("#loadMoreButton").hide();
            }
        }

        function filterCategories(target) {
            if (loadedProducts === 0) {
                return;
            }
            target = Number(target);
            currentFilter = target;

            let elements = $("[id^='category-']");
            if (target === 0) {
                let notLoadedFound = false;
                for (let [id, category] of categories) {
                    if (!category["isLoaded"]) {
                        notLoadedFound = true;
                    }
                    console.log(category, !notLoadedFound && category["productsCount"] !== 0);
                    elements.filter(`#category-${id}`).toggle(!notLoadedFound && category["productsCount"] !== 0);
                }
                $("#loadMoreButton").toggle(notLoadedFound);
                return;
            }

            elements.not(`#category-${target}`).hide();
            elements.filter(`#category-${target}`).show();

            let categ = categories.get(target);
            if (!categ["isLoaded"]) {
                loadCategory(categ["id"], categ["name"], null, true);
            }

            $("#loadMoreButton").hide();
        }

        function getOrCreateCategoryElement(id) {
            const elemId = `category-${id}`;
            let element = $(`#${elemId}`);
            if (element.length === 0) {
                const templ = document.createElement("div");
                templ.innerHTML = $("#categoryTemplate").html();
                element = $(templ);
                element.attr("id", elemId);
                element.data("category-id", id);
                element.find(".productsBag").children().remove();
                element.hide();

                $("#categoriesBag").append(element);
            }

            return element;
        }

        function addProduct(categoryId, product) {
            const productsBag = $(`#category-${categoryId} .productsBag`);
            let productElement = productsBag.find(`[data-product-id='${product.id}']`);
            if (productElement.length > 0) {
                productElement.remove();
            }

            productElement = $("#productTemplate").clone();
            productElement.attr("id", null);
            productElement.data("product-id", product.id);
            productElement.find(".cell > span").first().removeClass("is-skeleton").addClass("has-text-grey-light").text(product.description);
            productElement.find(".productNumber").removeClass("is-skeleton").addClass("has-text-white-ter").text(product.number);
            productElement.find(".productScore").removeClass("is-skeleton").addClass("has-text-white-ter").text(product.score);
            productElement.find(".productProducedAtIcon").removeClass("is-skeleton");

            const date = new Date(product["producedAt"]);
            const dateString = ('0' + (date.getMonth() + 1)).slice(-2) + '/' + ('0' + date.getDate()).slice(-2);
            productElement.find(".productProducedAt").removeClass("is-skeleton").addClass("has-text-white-ter").text(dateString);
            productElement.find(".productBuyButton").removeClass("is-skeleton").text(`Buy ${+Number(product.price).toFixed(2)}$`).click(() => showConfirmation(product));

            productsBag.append(productElement);
        }

        function buyProduct(productId) {
            $.post({
                url: `/api/products/${productId}/buy/`,
                dataType: "json",
                success: function (data) {
                    window.location.href = "/purchases/"
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    tryHandleAuthError(jqXHR);

                    showError(jqXHR);
                }
            });
        }

        function showConfirmation(product) {
            const confirmation = $("#buyConfirmation");
            confirmation.css("display", "flex");

            $("#confirmationProductDescription").text('"' + product.description + '"');
            $("#confirmationProductPrice").text(`Buy for ${Number(product.price)}$`);
            confirmation.find("button").first().click(() => confirmation.css("display", "none"));
            confirmation.find("button").last().click(() => { confirmation.css("display", "none"); buyProduct(product.id) });
        }

        function loadArticle() {
            $.get({
                url: "/api/news/",
                dataType: "json",
                success: function(data) {
                    const articleElement = $("#article");
                    if (data.length === 0) {
                        articleElement.hide();
                        return;
                    }

                    const article = data[0];
                    articleElement.find(".is-skeleton").removeClass("is-skeleton");

                    articleElement.find(".article-title > span:nth-child(2)").addClass("has-text-white-ter").text(article.title);
                    articleElement.find(".article-date").addClass("has-text-grey-dark").text(toDateUSFull(new Date(article.createdAt)));
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    tryHandleAuthError(jqXHR);

                    showError(jqXHR);
                }
            });
        }

</script>

<div id="buyConfirmation" class="custom-modal" style="display: none;">
    <div class="box has-text-centered">
        <h6 class="title has-text-centered is-5">Confirmation</h6>
        <span>You are going to buy <b id="confirmationProductDescription">"Product description Product description"</b>.<br> Are you sure?</span>
        <div class="mt-5" style="display: flex; justify-content: center; gap: 1rem;">
            <button class="button is-outlined is-rounded px-5" style="color: var(--bulma-box-color); border-color: var(--bulma-box-color); width: 8rem;">Cancel</button>
            <button class="button is-primary is-outlined is-rounded px-5" style="width: 8rem;" id="confirmationProductPrice"></button>
        </div>
    </div>
</div>

<div class="scroll-to-top-button" onclick="toTopButton.trigger('mouseleave'); scrollToTop()" style="display: none;">
    <span class="icon" style="width: 100%; height: 100%; text-align: center; vertical-align: center; font-size: 32px;">
        <i class="fas fa-arrow-up"></i>
    </span>
</div>

<section class="section container pt-4 pb-2">
    <div class="columns is-centered">
        <div class="column is-12">
            <div class="pageContent">

                <div id="article" class="box main-page-article" onclick="window.location.href = '/news'">
                    <div class="article-header">
                        <span class="is-size-6 has-text-weight-bold article-title" style="flex-grow: 1;">
                            <span class="icon is-size-4 has-text-info mr-5">
                                <i class="fas fa-newspaper"></i>
                            </span>

                            <span class="is-skeleton">
                                Lorem ipsum dolor sit amet!
                            </span>

                            <span class="icon ml-3 has-text-grey-dark">
                                <i class="fas fa-up-right-from-square"></i>
                            </span>
                        </span>
                        <span class="is-size-6 has-text-weight-bold ml-3 article-date is-skeleton">00/00/0000</span>
                    </div>
                </div>

                <div class="level is-mobile">
                    <div class="level-left">
                        <div class="level-item">
                            <div class="control has-icons-left">
                                <div class="select is-rounded">
                                    <select id="categoriesSelect" class="is-skeleton">
                                        <option value="0">All categories</option>
                                    </select>
                                </div>
                                <span class="icon is-medium is-left">
                                    <i class="fas fa-filter"></i>
                                </span>
                            </div>

                        </div>
                    </div>
                </div>

                <div id="noProducts" class="box my-2 py-4 has-text-centered" style="display: none;">
                    <span class="has-text-weight-bold has-text-white-ter" style="font-size: 1.15rem">At the moment, all products on site have been sold. New goods will be available coming soon!</span>
                </div>

                <div id="categoriesBag">
                    <div id="categoryTemplate">
                        <div>
                            <div class="box mt-5 mb-0 py-2">
                                <div class="fixed-grid has-3-cols-mobile has-9-cols-tablet">
                                    <div class="grid">
                                        <div class="cell is-col-span-5 is-align-items-center is-flex">
                                            <span class="is-size-5 is-skeleton">SKELETON SKELETON</span>
                                            <button class="button is-primary is-outlined is-rounded ml-4" style="--bulma-button-padding-vertical: 0.1em; display: none;">
                                                <span>Description</span>
                                            </button>
                                        </div>
                                        <div class="cell is-align-items-center is-justify-content-center is-flex is-hidden-mobile">
                                            <span class="has-text-weight-bold has-text-white-ter">Balance</span>
                                        </div>
                                        <div class="cell is-align-items-center is-justify-content-center is-flex is-hidden-mobile">
                                            <span class="has-text-weight-bold has-text-white-ter">State</span>
                                        </div>
                                        <div class="cell is-align-items-center is-justify-content-center is-flex is-hidden-mobile">
                                            <span class="has-text-weight-bold has-text-white-ter">Date</span>
                                        </div>
                                        <div class="cell is-align-items-center is-justify-content-center is-flex is-hidden-mobile">

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="productsBag">

                                <div id="productTemplate" class="box my-2 py-2">
                                    <div class="fixed-grid has-3-cols-mobile has-9-cols-tablet">
                                        <div class="grid">
                                            <div class="cell is-col-span-5 is-align-items-center is-flex">
                                                <span class="is-skeleton">Not very long description of the first product</span>
                                            </div>
                                            <div class="cell is-align-items-center is-justify-content-center is-flex">
                                                <span class="productNumber has-text-weight-bold is-skeleton">11111111</span>
                                            </div>
                                            <div class="cell is-align-items-center is-justify-content-center is-flex">
                                                <span class="productScore has-text-weight-bold is-skeleton">AA</span>
                                            </div>
                                            <div class="cell is-align-items-center is-justify-content-center is-flex">
                                                <span class="productProducedAtIcon is-skeleton icon is-small has-text-white-ter mr-1">
                                                    <i class="fa-solid fa-calendar-days"></i>
                                                </span>
                                                <span class="productProducedAt has-text-weight-bold is-skeleton">00/00</span>
                                            </div>
                                            <div class="cell is-align-items-center is-justify-content-center is-flex">
                                                <button class="productBuyButton button is-primary is-outlined is-rounded is-skeleton">Buy 00$</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <button id="loadMoreButton" class="button load-more-button is-rounded mt-4 py-3" onclick="loadAdditionalCategories()">
                    Load more...
                </button>
            </div>
        </div>
    </div>
</section>

<section class="section container mt-0 pt-0 mb-5 pb-0 footer-custom">
    <div class="columns is-centered">
        <div class="column is-12">
            <div class="box mt-5">
                <div class="footer-qrs">
                    <div class="footer-qr">
                        <a href="https://t.me/MIAMI_CASH_TEAM" target="_blank">
                            <img src="static/img/qr_tg_team.png" width="120" height="120"/>
                        </a>
                        <div>
                            <a href="https://t.me/MIAMI_CASH_TEAM" target="_blank">
                                <span class="icon">
                                    <i class="fa-brands fa-telegram"></i>
                                </span>
                                OUR CHANNEL:<br>
                                @MIAMI_CASH_TEAM
                            </a>
                        </div>
                    </div>

                    <div class="vertical-line"></div>

                    <div class="footer-qr">
                            <a href="https://t.me/MIAMI_CASH_FEEDBACK" target="_blank">
                                <img src="static/img/qr_tg_feedback.png" width="120" height="120"/>
                            </a>
                            <div>
                                <a href="https://t.me/MIAMI_CASH_FEEDBACK" target="_blank">
                                    <span class="icon">
                                        <i class="fa-brands fa-telegram"></i>
                                    </span>
                                    OUR FEEDBACK:<br>
                                    @MIAMI_CASH_FEEDBACK
                                </a>
                            </div>

                    </div>
                </div>

                <div class="footer-copyrights">
                    <span>©2020-2025 Miami Cash, All Rights Reserved.</span>
                </div>
            </div>

        </div>
    </div>
</section>
</body>
</html>