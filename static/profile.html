<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/static/styles/style.css">
    <script type="text/javascript" src="/static/js/jquery-3.7.1.min.js"></script>
    <script type="text/javascript" src="/static/js/app.js"></script>
    <script type="text/javascript" src="/static/js/header.js"></script>
    <title>Miami Cash: Profile</title>
</head>
<body>

<script>
    HEADER_USER_DROPDOWN_ACTIVE = ".edit-button";

    $(document).ready(function() {
        loadProfile();

        $("#password-button").click(() => submit("password"));
        $("#phrase-button").click(() => submit("phrase"));

        setDontMatch("password", false);
        setDontMatch("phrase", false);
        setFieldError($("#password-field"));
        setFieldError($("#phrase-field"));

        showOnLoadNotification()
    });

    function getBlockName(block) {
        return block === "password" ? "Password" : "Phrase"
    }

    function setDontMatch(block, active) {
        const text = active ? `${getBlockName(block)}s don't match` : "";
        setFieldError($(`#${block}1-field`), text);
        setFieldError($(`#${block}2-field`), text);
    }

    function submit(block) {
        const current = $(`#${block}-field .input`).val();
        const new1 = $(`#${block}1-field .input`).val();
        const new2 = $(`#${block}2-field .input`).val();

        const blockName = getBlockName(block);

        setDontMatch(block, false);
        setFieldError($(`#${block}-field`));

        if (current == null || current.trim() === "") {
            setFieldError($(`#${block}-field`), `${blockName} is required`);
            return;
        }

        if (new1 === null || new1.trim() === "") {
            setFieldError($(`#${block}1-field`), `${blockName} is required`);
            return;
        }

        if (new1 !== new2) {
            setDontMatch(block, true);
            return;
        }

        const request = {}
        const fieldName = block === "password" ? "password" : "secretPhrase";
        request[fieldName] = current;
        request[fieldName + "New"] = new1;
        $(`#${block}-button`).addClass("is-loading");

        $.post({
            data: request,
            url: "/api/account/",
            dataType: "json",
            success: function() {
                localStorage.setItem("profile_onLoadNotification", `${blockName} has been successfully updated.`);
                window.location.href = "/profile";    // перезагрузка нужна, чтобы появлялись окна сохранения пароля в некоторых браузерах (в т. ч. Chrome)
            },
            error: function(jqXHR, textStatus, errorThrown) {
                tryHandleAuthError(jqXHR);

                try {
                    let errors = JSON.parse(jqXHR.responseText);

                    let found = false;
                    const fieldName = block === "password" ? "password" : "secretPhrase";
                    if (fieldName in errors) {
                        setFieldError($(`#${block}-field`), errors[fieldName]);
                        found = true;
                    }
                    if (fieldName + "New" in errors) {
                        setFieldError($(`#${block}1-field`), errors[fieldName + "New"]);
                        found = true;
                    }

                    if (!found) {
                        showError(jqXHR);
                    }
                }
                catch (e) {
                    console.error("Failed to parse JSON error: " + e);
                    console.error("Response: " + jqXHR.responseText);
                    showError("An internal error occured during the request. Please, try again.")
                }
            },
            complete: function() {
                $(`#${block}-button`).removeClass("is-loading");
            }
        })
    }

    function showOnLoadNotification() {
        const notification = localStorage.getItem("profile_onLoadNotification");
        if (notification) {
            notify(notification, "success", 5000);
            localStorage.removeItem("profile_onLoadNotification");
        }
    }

</script>

<iframe src="/static/blank.html" id="formTarget" name="formTarget" style="display: none">
</iframe>

<section class="section container pt-4">
    <div class="columns is-centered">
        <div class="column is-12">

            <div class="profile-blocks">
                <div class="box profile-block">
                    <h5 class="title is-5 has-text-centered mb-5">CHANGE PASSWORD</h5>

                    <div class="field mb-5" id="password-field">
                        <label class="label">Current password</label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input" type="password" name="password" placeholder="Enter your current password"
                                   autocomplete="current-password">
                            <span class="icon is-small is-left">
                                <i class="fas fa-key"></i>
                            </span>
                            <span class="icon is-small is-right">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <form id="password-form" method="post" action="/api/return/200/" target="formTarget">
                        <div class="field" id="password1-field">
                            <label class="label">New password</label>
                            <div class="control has-icons-left has-icons-right">
                                <input class="input" type="password" name="password1" placeholder="Enter your new password"
                                       autocomplete="new-password">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-key"></i>
                                </span>
                                <span class="icon is-small is-right">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                            </div>
                            <p class="help is-danger"></p>
                        </div>

                        <div class="field" id="password2-field">
                            <label class="label">New password confirmation</label>
                            <div class="control has-icons-left has-icons-right">
                                <input class="input" type="password" name="password2" placeholder="Re-enter your new password"
                                       autocomplete="new-password">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-key"></i>
                                </span>
                                <span class="icon is-small is-right">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                            </div>
                            <p class="help is-danger"></p>
                        </div>

                        <button class="button mt-6 is-outlined is-medium is-fullwidth is-primary" id="password-button" type="submit">Change password
                        </button>
                    </form>
                </div>


                <div class="box" style="flex: 1; min-height: 300px">
                    <h5 class="title is-5 has-text-centered mb-5">CHANGE SECRET PHRASE</h5>

                    <div class="field mb-5" id="phrase-field">
                        <label class="label">Current secret phrase</label>
                        <div class="control has-icons-left has-icons-right">
                            <input class="input" type="password" name="password"
                                   placeholder="Enter your current secret phrase"
                                   autocomplete="current-password">
                            <span class="icon is-small is-left">
                                <i class="fas fa-user-secret"></i>
                            </span>
                            <span class="icon is-small is-right">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                        </div>
                        <p class="help is-danger"></p>
                    </div>

                    <form id="phrase-form" method="post" action="/api/return/200/" target="formTarget">
                        <div class="field" id="phrase1-field">
                            <label class="label">New secret phrase</label>
                            <div class="control has-icons-left has-icons-right">
                                <input class="input" type="password" name="password1" placeholder="Enter your new secret phrase"
                                       autocomplete="new-password">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-user-secret"></i>
                                </span>
                                <span class="icon is-small is-right">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                            </div>
                            <p class="help is-danger"></p>
                        </div>

                        <div class="field" id="phrase2-field">
                            <label class="label">New secret phrase confirmation</label>
                            <div class="control has-icons-left has-icons-right">
                                <input class="input" type="password" name="password2"
                                       placeholder="Re-enter your new secert phrase"
                                       autocomplete="new-password">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-user-secret"></i>
                                </span>
                                <span class="icon is-small is-right">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </span>
                            </div>
                            <p class="help is-danger"></p>
                        </div>

                        <button class="button mt-6 is-outlined is-medium is-fullwidth is-primary" id="phrase-button"
                                type="submit">Change secret phrase
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section container mt-0 pt-0 mb-5 pb-0 footer-custom">
    <div class="columns is-centered">
        <div class="column is-12">
            <div class="box mt-5">
                <div class="footer-qrs">
                    <div class="footer-qr">
                        <a href="https://t.me/miami_cash_linkz" target="_blank">
                            <img src="static/img/qr_tg_team.png" width="120" height="120"/>
                        </a>
                        <div>
                            <a href="https://t.me/miami_cash_linkz" target="_blank">
                                <span class="icon">
                                    <i class="fa-brands fa-telegram"></i>
                                </span>
                                OUR CHANNEL:<br>
                                @MIAMI_CASH_LINKS
                            </a>
                        </div>
                    </div>

                    <div class="vertical-line"></div>

                    <div class="footer-qr">
                            <a href="https://t.me/MIAMICASHBOT" target="_blank">
                                <img src="static/img/qr_tg_bot.png" width="120" height="120"/>
                            </a>
                            <div>
                                <a href="https://t.me/MIAMICASHBOT" target="_blank">
                                    <span class="icon">
                                        <i class="fa-brands fa-telegram"></i>
                                    </span>
                                    OUR TG BOT:<br>
                                    @MIAMICASHBOT
                                </a>
                            </div>

                    </div>
                </div>

                <div class="footer-copyrights">
                    <span>©2020-2025 Miami Cash, All Rights Reserved.</span>
                </div>
            </div>

        </div>
    </div>
</section>
</body>
</html>